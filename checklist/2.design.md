# Design
- 設計書の記載レベルのチェックリスト
- 設計フェーズでの準備・検討項目

## Contents
- I（インプット）：前提条件・事前準備（フェーズごとの運用ルールの展開等）
  - スケジュール：WBS、イベント（逆算必要なクリティカルパス）
  - 体制・会議帯：体制（体制図）と日次・週間の会議帯（参加者）を定義
  - ツール：レポート（フォーマット）・進捗管理
  - レビュープロセス定義（完了条件）
  - 設計書フォーマット：バージョン管理方針も（更新箇所は色つけるか）
- P（プロセス）：進め方
  - 設計ドリブンだとオーバーエンジニアリングなりがち（決めなくていいことは決めない）
  - アウトプットは必ずレビューする
- O（アウトプット）：
  - 設計書（API・テーブル定義）
  - ハイレベルな方針定義（重要！テストフェーズでの検討開始は手戻り大きい）
    - アプリ方針定義
    - アーキ方針定義
  - 評価・分析（QCD観点）
    - 生産性の評価：計画との乖離
    - QCD観点で総合評価（トレードオフ関係のため、オンスケでも、品質面を含めて評価）

<br>

## CheckList
### Documet Review  
!!! tip TIP: ドキュメントレビュー前チェック
    - 構造品質：機械的にチェック可能。０件指摘が好ましい）
    - 機能品質：観点あれば、レビュイーがレビュー時に伝える

<br>

### High Level Design Document (APP)
#### MUST
- Naming：kebav vs lower-camel（一貫性）
  - エンドポイント名、カラム名、テーブル名
- API
  - エンプティケース（必須ではない項目を空で登録する場合、DBレコードは　empty vs NULL）？
  - 現在日時（現在時刻はみなし日 vs SysDate？）
  - エラーハンドリング管理・プロセス（楽観排他・悲観排他）
  - 一覧レスポンス：limit/offset/total
  - 共通項目：createDate/deleteFlag
  - 楽観・悲観ロック
  - 非同期通信複数の場合は一部成功によるロールバック時処理も定義
  - 更新方針：upsert vs delete&insert 
- DB
  - テーブル定義（データモデル：何トリガーで作成され削除されるかのライフサイクルも）
  - インデックス：B-Tree（ホットスポット注意）
- Batch
  - CSVアップロード：BOM付き?文字コード?

#### Nice To Have
- Wording：業務用語（発注、注文：order？）

<br>

### High Level Design Document (Arch)
#### MUST
- System Arch
  - 環境利用計画（バッチのメモリ数など）
  - フレームワーク管理（EOL：リリース時にサポート終了しないか）
  - 通報・通知プロセス：シビリティ（バグの重大度）
  - ログ出力方針：レベル（通報対象）/出力（マスク対象）/ 管理（ローテーション）
  - 通信処理： HTTP1.1?
  - 文字コード：外字
  - バージョン管理（バージョニング）：サーバー停止しなくてもバージョンアップ可能か
- API
  - ステータスコード方針：200, 302, 400
  - HTTPヘッダ管理：「X-系」
  - キャッシュ方針・管理：RFC 7234
    - Cache-Control：must-revalidate、no-cache、no-store、no-transform、public、private、proxy-revalidate、max-age、s-maxage
    - Expires（Cache-Control: max-ageと同じ）
    - ETag（更新チェック）
    - Last-Modified（更新チェック）
    - Vary（同一URLでPC向け・スマホ向けページ分ける場合）
  - Cookie方針・管理（★有効期限注意）
    - HTTP ONLY： Cookiesの盗聴を防ぐ（jsから参照・更新不可）
  - 認証・認証方針
    - Bearer認証：ステートレス認証
    - SSO：Kerberos認証（LDAP）、OAuth 2.0/OIDC（Bearer認証）、（PKCE、NONCEチェック）、WebAuthN
    - トークン（リフレッシュトークン）：有効期限。期限切れ後の挙動
  - 通信リトライ（exponential backoff）
    - ジッタ（スロットリング）：リトライ間隔
    - バックオフ：回数、閾値
- DB
  - トランザクション分離レベル（不整合）
  - 文字コード
  - shared_buffers（共有バッファ：デフォルト値は32MB）：※ディスクスワップの発生によって性能を低下注意
  - checkpoint_timeout：長いとWALファイルサイズ、障害発生時の復旧に必要な時間が長くなる
  - タイムアウト（２種類：セッションごとに設定可能）
      - statement_timeout：処理完了待ちのタイムアウト
      - lock_timeout：ロックを取得待ちのタイムアウト
- Security
  - データ型
    - 暗号化（AES：CBC or CTRの暗号化モード）
    - ハッシュ（パスワードハッシュ）
      - 関数：PBKDF2、bcrypt
      - アルゴリズム：SHA3-512（512 ビット, 128桁：sha family）
      - 強度設定値
        - ソルト：ユーザ毎に異なる値を割り振る（ハッシュ値と一緒保存する）★レインボーテーブル、パスワードリスト攻撃対策
        - ストレッチング：数千から数万回ほど繰り返しハッシュ化（サーバー負荷とトレードオフ）
        - ペッパー：サイト内で保存する一意の値
    - HMAC（改竄検知）
  - 脆弱性対応方針：根本対策と保険的対策区別する（保険的対策で保護範囲を広げる）
    - MITM：HSTS設定ありなし
    - XSS：フォーム入力でHTMLエスケープ（対象 5記号 <>"'&）
    - CSRF：HTTP Cookie の SameSite 属性確認。Csrfトークン設定
    - その他：SQLインジェクション
- Batch
  - 実行方式（起動パラメータ等）
  - 実行スケジュール（何分以内に終わる必要あるか）
  - リランポリシー（アベンド時は、リラン可能?、繰り返し実行可能か）

#### Nice To Have

<br>

## DataBase

### Table Design
- Wording：業務用語（発注、注文：order？）
    - ヘボン式のローマ字は非推奨。（ただし、医療系(臓器、病名)などはヘボン式でもよい）
    - インデント、大文字、小文字ルールは統一
- テーブル設計
    - ライフサイクルを明確化：作成・更新・削除トリガー
    - 配列型を使うと、第一正規化が崩れるので注意
    - モデリング
        - アトリビュート：PK・UK・FK
        - カーディナリティ：1:1（- - -）・1:N（- -＜）・N:N（＞-＜）
        - オプショナリティ：存在しないケースあり：（○）・存在しないケースなし：（｜）
- カラム設計
    - カラムダブルミーニングはNG
- 制約
    - ドメイン制約（CHECK）
    - 一意制約（UNIQUE　⇨ NULL　OK）
    - NOT NULL
- データ型
    - [文字列型](https://www.postgresql.org/docs/current/datatype-character.html)
        - varchar(n)：variable-length with limit
        - char(n)：末尾スペースを無視する
        - text：1GB
    - 数値型：
        - 少数含まない
            - smallint（2 bytes）：-32768 to +32767（３万２千）
            - integer（4 bytes）：-2147483648 to +2147483647（21億）
            - bigint（8 bytes）
        - 少数含む
        - decimal/numeric
    - 日時
        - timestamp(6)（2 bytes）：
        - timestamp(6) with timezone（2 bytes）：UTCで格納される
- デフォルト値
    - NULL（NOW()？0?）
- インデックス：検索項目対象（定義する場合は理由も明記する）
    - インデックス追加対象（検索項目）
        - WHERE条件
        - 結合条件
        - ORDEY BY条件
        - 数十万件以上のテーブル（数万しかない場合は効果ない）
    - サロゲートキーは非推奨：Right Growing Index（同じリーフに更新が集中）
    - インデックスが使われないケース
        - 否定系はインデックス使われない。「NOT IN」 、「<>」
        - ORはインデックス使われない。
        - Like検索は、前方一致のみ。
    - PK・unique key両方B-treeインデックスが自動で作成される

!!! tip TIP: 積み上げモデル
    - 履歴を保つ：履歴を保つことでキャンセル時に対応可能となる（トリガー利用）

### SQL：
- INNER JOIN（（ベン図の重なりのみ抽出）） or LEFT JOIN（ベン図の左丸の部分のみ抽出）
- Between 上限・下限（<= && >=）含む
- COUNT
  - COUNT(1) ：NULLも数える
  - COUNT(user_name)：NULLも数えない
- JOIN USING句（同一列名）を使う：結合後列減少するので、select でテーブル指定不要
- Like検索
    - ILIKEの場合は大文字小文字を区別しない
- テクニック
    - ALL「1」を探す場合
        - WHERE 1 = ALL (col 1, col 2, col 3, col 4, col 5, col 6, col 7, col 8, col 9, col 10);
    - ALL「Null」を探す場合
        - WHERE COALESCE (col1, col2, col3) is NULL
- ワイルドカード
    - パーセント(%)： 0 個以上の何らかの文字列
    - アンダースコア(_)は 1 個の何らかの文字列

<br>

### Tuning
- バルクインサートよりコピー
- インデックスを利用する
    - WHERE
        - 左辺で計算しない
        - Like検索は、前方一致のみインデックス使われる。
        - 否定系はインデックス使われない。「NOT IN」 、「<>」
        - ORはインデックス使われない。**「OR」より「IN」（★）**
        - 複合インデックス：
        - 部分インデックス：削除フラグがFalseなど
        - 式インデックス：
    - GROUP BY とORDER BYでインデックスを使う
    - 極地関数Max() Minなどで、indexを使う
- 早期リターン：
    - **（サブクエリの場合）INよりEXISTS（★）**
- ソート回避：
    - **DISTINCTよりEXISTS（★）**
- 表を小さく
    - 結合しすぎない：表が大きくなりすぎるとソートでメモリ足らず（クイックソートではなく外部ソートになる）
        - スカラ・サブクエリ：**コード値を名前変換等**（★）
    - 再利用する：メモリ観点
        - **サブクエリよりWITH（★）**
- 実行Plan確認
    - スキャンノード：Seq Scan / index Scan / index Only Scan
    - 結合ノード：Nested Loop：BigO（n^2） / Hash Join / Merge Join：
    - ソートノード：QuickソートならOK、外部ソートはNG（メモリサイズが原因）
- 文字連結
    - concat ：NULLは空白に変換（「田中」+「NULL」= 「田中」）
        - ||：NULLを含むとNULLになる（「田中」+「NULL」= 「NULL」）

<br>

### References
- ORDER(select)：https://www.postgresql.org/docs/16/sql-select.html
- クエリサンプル
    - https://gist.github.com/linyows/d81319d00543e6d0093136fd7668637b
    - https://repost.aws/ja/knowledge-center/rds-postgresql-replication-lag
    - https://qiita.com/mkyz08/items/ff4474a5546a62adc580
    - https://learn.microsoft.com/ja-jp/azure/cosmos-db/postgresql/howto-useful-diagnostic-queries
- RDS（AWS）
    - Amazon RDS for PostgreSQL：https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html#PostgreSQL.Concepts.General.DBVersions
    - Release：https://docs.aws.amazon.com/AmazonRDS/latest/PostgreSQLReleaseNotes/postgresql-release-calendar.html
- チューニングガイド
    - Citus Data（米マイクロソフト買収：PostgreSQL用の分散データベースエンジンの開発）
        - https://www.citusdata.com/blog/2018/02/22/seven-tips-for-dealing-with-postgres-locks/
    - あまり知られていないPostgreSQLの機能：https://postd.cc/postgresql-unknown-features/#08
        - 連番：SERIAL（非推奨）→ GENERATED ALWAYS：連番項目を指定できないようにする（一意性制約違反が発生しにくくなる）
        - パターンマッチ：regexp（例：~ ANY(ARRAY['@gmail\.com$', '@yahoo\.com$'])）
        - UPSERT：クエリ例：INSERT ON CONFLICT
        - DISTINCT ON：重複削除したカラムの、他カラム情報が欲しい
        - gen_random_uuid()：ランダムなUUID（バージョン4）を生成する
    - 達人に学ぶSQL徹底指南書：https://zenn.dev/itoo/articles/sql_learn_master
